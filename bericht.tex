\documentclass[12pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage[german]{babel}
\usepackage[T1]{fontenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage[european, siunitx, strokediode]{circuitikz}
\usepackage{pgfplots} 
\usepackage{float}
\usepackage{fontspec}
\usepackage{tcolorbox}
\usepackage{fancyhdr}
\usepackage{titling}
\usepackage{csvsimple}
\usepackage{filecontents}
\usepackage{pdfpages}
\usepackage{listings}
\usepackage[left=2cm,right=2cm,top=2cm,bottom=2cm]{geometry}
\usepackage{titlesec}
\usepackage{lastpage}

\usepackage[pdfauthor={tyrolyean},
            pdftitle={AQUADOC},
            pdfproducer={4BHN},
            pdfcreator={xelatex}]{hyperref}

\author{Manuel Ljubic, Jack Neuner, Daniel Plank}
\title{AquadDoc}
\setmainfont{Arial}

% #############################################################################
% Compilation options. Used to enable or disable some parts of the document.
% #############################################################################

% Include the used datasheets in the document
\def\datasheets{0}

\def\psocdisasm{0}

\pagestyle{fancy}
\fancyhf{}
\rhead{\thetitle}
\lhead{HN4-FTKL}
\cfoot{Seite \thepage von \pageref{LastPage}}
\rfoot{Ljubic, Plank, Neuner}
\lfoot{}

\renewcommand{\headrulewidth}{.4mm}
\renewcommand{\footrulewidth}{.4mm}


% Define lst listing styles
\lstdefinestyle{customc}{
  belowcaptionskip=1\baselineskip,
  breaklines=true,
  frame=L,
  xleftmargin=\parindent,
  language=C,
  showstringspaces=false,
  keywordstyle=\bfseries\color{green!40!black},
  commentstyle=\itshape\color{purple!40!black},
  identifierstyle=\color{blue},
  stringstyle=\color{orange},
}

\lstdefinestyle{customasm}{
  belowcaptionskip=1\baselineskip,
  frame=L,
  xleftmargin=\parindent,
  language=[x86masm]Assembler,
  basicstyle=\footnotesize\ttfamily,
  commentstyle=\itshape\color{purple!40!black},
}

\lstset{escapechar=@,style=customc}

\begin{document}
\begin{titlepage}
\begin{center}
\setlength{\fboxrule}{1mm}
\framebox{

	\parbox{\textwidth}{
	
		\vspace{6mm}
		\centering
		\textbf{\Huge HN4-FTKL}
		\break
		\Large{
			Abteilung Elektronik \break
		}
		
		\normalsize{
			an der Höheren technischen Bundeslehranstalt 1 \break
			Innsbruck, Anichstraße 26 – 28 \break
		}
	}
}
\break
\vspace{1mm}
\setlength{\fboxrule}{.1mm}
\framebox{
	\parbox{\textwidth}{
		\textbf{\maketitle}
		\centering
		\textbf{Dokumentation des Wasserhaushalts einer 
	Wasserversorgungsanlage für Kleinsiedlungsgebiete}
		\vspace{1cm}
	}
}

\end{center}
\end{titlepage}

\tableofcontents
\newpage

\section{Aufgabenstellung}

\subsection{Aufbau}
\begin{figure}[H]
	\centering
	\def\svgwidth{\columnwidth}
	\input{aufbau.pdf_tex}

	\label{fig:schemaufb}
	

\end{figure}

Ein Hochbehälter hat ein Fassungsvermögen um 1 Tag Wasser speichern zu können
und ein Feuer zu löschen.

\subsection{Sensoren}

\begin{itemize}
	\item{Wasser zwischen Quelle und Brunnen und Brunnen und Häuser} \\
	 Umsetzung mittels Rotor mit Magnet an einer Schaufel, welcher einen
	 REED-Kontakt schaltet. Aufgabe: Prellt dieser Schalter?
	 \begin{figure}[H]
		\centering
		\includegraphics[width=0.5\textwidth]{Reed.png}
		\label{fig:reed}
		\caption{Schemata eines Reed-Schalters}
	\end{figure}

	\item{Wassertemperatur} \\
	Digitaler Sensor --> Auflösung von 0.01°C

	\item{Wasserstand}
	Füllstand HB: Drucksensor, Ultraschallsensor, Potentiometer mit
	Schwimmer, etc.

	\item{Türschalter}
	\item{Batteriestandsanzeige}


\end{itemize}

Anforderungen an die Funkübertragung:
\begin{itemize}
	\item{Datensicherheit}
	\item{Übertragungsmöglichkeit (Manchester Kodierung)}
	\item{Übertragungsantenne}
\end{itemize}

Gefundene Bauteile auf neuhold-elektronik.at:
\begin{itemize}
	\item{DS1722}: \\
	SPI Digital Thermometer. 8-12 bit Auflösung.

	\item{HC - SR04}: \\
	PWM Ultraschall Messmodul. 2mA standby strom.
	
	\item{MAX640}: \\
	5V Step-Down DC-DC Converter.

	
\end{itemize}

\section{Test mittels Aurduino}

Es wird ein Arduino verwendet um die gegebenen Sensoren DS1722 bzw. HC-SR04 zu 
testen. Die SPI anschlüsse des Arduinos werden mit den Anschlüssen der
jeweiligen Sensoren verbunden und auf die Verwendung der richtigen 
Versorgungsspannung wird geachtet.

\newpage
\subsection{HC-SR04}

\lstinputlisting[language=C++, numbers=left, frame=trBL, breaklines=true,
 breakautoindent=true, formfeed=\newpage, label={lst:ardu_hc-sr04},
 caption={Arduino Programm für HC-SR04}, columns=flexible]
 {./arduino/HC-SR04/HC-SR04.ino}

\newpage
\subsection{DS1722}

\lstinputlisting[language=C++, numbers=left, frame=trBL, breaklines=true,
 breakautoindent=true, formfeed=\newpage, label={lst:ardu_ds1722},
 caption={Arduino Programm für DS1722}, columns=flexible]
 {./arduino/DS1722/DS1722.ino}

\if\psocdisasm

\section{PSoC}

\subsection{General Information}

The Programmble System on a chip (also known as PSoC) is a family of ARM 32bit
Microprocessors with a few FPGA elements present on the IC. At the beginning of
writing of this document neither feasible documentation from the side of Cypress
nor any sourcecode is present.

The focus of this document is soley on the CY8C5888LTI-LP097 chip, which is part
of the PSoC 5 series of integrated circuits.

\subsection{Reason}

The reason for this document is, that the PSoC series of chips from cypress is
used by us in school, but no one actually has knowledge of it's inner workings,
or how this thing works beyond the PSoC-Creator, which is an IDE for 
windows(TM).

\subsection{Hardware component Description}

\subsubsection{CPU}

The cpu on the given PSoC is ARM Cortex M3 based clocked at a maximum of 80 MHz.
The PSoC creator uses a standart ARM-GCC which is developed and maintained by
the KEIL Software, a subsidary of the ARM Holding. It therefore uses an open
toolchain, which is freely available and maintained.

\subsection{PGA}

The PSoC has a onboard PGA used to connect internal ports to some gates and
harware components. The drawing program in the PSoC IDE has a design elaborator,
used to 


\fi

\section{Durchführung Mittels PSoC}

	Die realisierung des Projektes mittels des PSoC Microcontrollers wurde
	vom Lehrer vorgegeben. Dafür wurden zuerst einzelprogramme erstellt,
	um die gewünschten Funktionalitäten einzeln zu testen. Die
	Einzelprogramme sollten dann zu einem Gesamtprogramm zusammengeführt
	werden, welches volle Funktionalität bietet.

\subsection{HC-SR04}

\subsubsection{Bauteilerklärung}
	
	Der HC-SR04 ist ein IC-Baustein, der Entfernung mittels Ultraschall
	misst. Dafür wird nach anlegen eines min. 10µs Pulses
	\footnote{Seite 2 HC-SR04 Datenblatt}
	am TRIG Pin
	eine Ultraschall Welle losgeschickt. Der Baustein rechnet sich dann aus
	der Laufzeit der Welle bis zu ihrer Rückkehr die Entfernung aus, und
	gibt diese dann als PWM Signal am echo pin aus. Manche
	Module scheinen dabei einen Defekt zu haben oder schlichtweg billiger
	gebaut zu sein, da man bei diesen klar eine Kondensatorladekurve
	erkennen kann. Die Messergebnisse stimmen jedoch mit denen eines
	Funktionstüchtigen HC-SR04 überein, wenn man von CMOS Logikpegeln
	ausgeht, also 3.5V und höher
	\footnote{Halbleiter-Schaltungstechnik Seite 639} als 
	WAHR annimmt. Das HC-SR04 Datenblatt behaupt hierbei jedoch, dass die
	Logikpegel TTL-Pegel seien, was einen kleinen Offset in diesem Falle
	zur Folge hätte. Dieser konnte jedoch bei uns nicht gemessen werden.
	

	\begin{figure}[H]
		
		\centering
		\begin{tikzpicture}
		\begin{axis}[
			ylabel=$ Spannung $,
			xlabel=$ Zeit $,
			grid=both,
			minor tick num=5,
			width=\textwidth,
			height=0.5\textwidth,
			ymin = -0.1,
			ymax = 5.1,
			% If you want to make the lines thick
			%every axis plot/.append style={ultra thick},
			xmin = -0.00014,
			xmax = 0.0027
		]
		
		\addplot table [x=time, y=echo, col sep=comma, mark=none, 
			color=green] {measurements/hc-sr04_should.csv};
		\addplot table [x=time, y=trig, col sep=comma, mark=none, 
			color=red] {measurements/hc-sr04_should.csv};
		
		\end{axis}
		\end{tikzpicture}
		\label{fig:hc-sr04_working}

		\caption{Messung mit einem funktionstüchtigen HC-SR04}
	\end{figure}
	
	\begin{figure}[H]
		
		\centering
		\begin{tikzpicture}
		\begin{axis}[
			ylabel=$ Spannung $,
			xlabel=$ Zeit $,
			width=\textwidth,
			height=0.5\textwidth,
			ymin = -0.1,
			ymax = 5.1,
			% If you want to make the lines thick
			%every axis plot/.append style={ultra thick},
			xmin = -0.00014,
		]
		
		\addplot table [x=time, y=echo, col sep=comma, mark=none, 
			color=green] {measurements/hc-sr04_fail.csv};
		\addplot table [x=time, y=trig, col sep=comma, mark=none, 
			color=red] {measurements/hc-sr04_fail.csv};
		
		\end{axis}
		\end{tikzpicture}
		\label{fig:hc-sr04_broken}

		\caption{Messung mit einem sich nicht normal verhaltenden 
			HC-SR04}
	\end{figure}

	Die gemessene Pulslänge in ms soll durch 57 dividiert werden um den
	Abstand in cm zu erhalten.

	\subsubsection{C-Code}

	\lstinputlisting[language=C, numbers=left, frame=trBL, breaklines=true,
	breakautoindent=true, formfeed=\newpage, label={lst:psoc_hc-sr04},
	caption={PSoC funktionen für HC-SR04}, columns=flexible]
	{psoc/psoc/Ultrasonic_test.cydsn/hcsr04.c}

	
	

\section{Anhang}

\subsection{Literaturverzeichnis}

\begin{itemize}
	
	\item{\textbf{HC-SR04 Datenblatt}}\\
		Erhalten von mouser.com am 2019-03-10.
	\item{\textbf{DS1722 Datenblatt}}\\
		Erhalten von maximintegrated.com am 2019-03-10.
	\item{\textbf{MAX640 Datenblatt}}\\
		Erhalten von maximintegrated.com am 2019-03-10.
	\item{\textbf{CY8C5888LTI-LP097 Datenblatt}}\\
		Erhalten von cypress.com am 2019-03-10.
	\item{\textbf{Ulrich Tietze Christoph Schenk 
		Halbleiter-Schaltungstechnik}}\\
		Vorliegend in 12. Auflage Springer-Verlag Berlin Heidelberg 2002

\end{itemize}

\if\datasheets1
	Die Angeführten Datenblätter wurden dem Dokument am Ende beigefügt.
\fi

\if\datasheets1
	\subsection{Datenblätter}

	\subsubsection{HC-SR04}
	\includepdf[pages={1-}]{./datasheets/HCSR04-1022824.pdf}

	\subsubsection{DS1722}
	\includepdf[pages={1-}]{./datasheets/DS1722.pdf}

	\subsubsection{MAX640}
	\includepdf[pages={1-}]{./datasheets/MAX639-MAX653.pdf}

	\subsubsection{CY8C5888LTI-LP097}
	\includepdf[pages={1-}]{./datasheets/CY8C5888LTI-LP097.pdf}

\fi % End of datasheet section
\end{document}

